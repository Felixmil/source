---
title: Opitimizing Mario Kart 8 Deluxe Gameplay
author: FÃ©lix
date: '2018-02-14'
categories:
  - Knowledge Discovery
slug: opitimizing-mario-kart-8-deluxe-gameplay
---


#Import data
```{r message=FALSE, warning=FALSE}
library(readxl)
Char<- read_xlsx("Mario Kart 8 Deluxe Stat.xlsx",sheet = "Char",col_names = T, col_types = c("text",rep("numeric", 12)))

Kart <- read_xlsx("Mario Kart 8 Deluxe Stat.xlsx",sheet = "Kart",col_names = T, col_types = c("text",rep("numeric", 12)))

Tire <- read_xlsx("Mario Kart 8 Deluxe Stat.xlsx",sheet = "Tire",col_names = T, col_types = c("text",rep("numeric", 12)))

Glide <- read_xlsx("Mario Kart 8 Deluxe Stat.xlsx",sheet = "Glide",col_names = T, col_types = c("text",rep("numeric", 12)))


library(tidyverse)
Char<-Char %>% add_column(Type="Char", .after='ID')
Kart <- Kart %>% add_column(Type="Kart", .after='ID')
Tire <- Tire %>% add_column(Type="Tire", .after='ID')
Glide <- Glide %>% add_column(Type="Glide", .after='ID')

data <-  full_join(Char, Kart) %>% full_join(Glide) %>% full_join(Tire)
```


#compute mean speed and handling
```{r}
data <- data %>%mutate(Speed_mean=rowMeans(data[grepl("Speed", names(data))])) %>% mutate(Handling_mean=rowMeans(data[grepl("Handling", names(data))]))
```

```{r}
library(qtlcharts)
iplotCorr(data %>% filter(Type=="Char") %>% select(-ID, -Type, -Speed_Land:-Speed_Gliding,-Handling_Land:-Handling_Gliding))

```

#How characters are distributed between Acceleration and Speed
```{r}
ggplot(data %>% filter(Type=="Char"), aes(x=Speed_mean,y=Accel))+geom_point(aes(size=Weight, fill=`M-turbo`), pch=21)+ggrepel::geom_text_repel(aes(label=ID), min.segment.length = 0.1,point.padding = unit(1.2, 'lines'),box.padding = unit(0.6, 'lines'), force=2)+viridis::scale_fill_viridis()
```
Fastest characters are also the heaviest and the ones with lowest acceleration, handling and Mini-turbo


#Wich Kart/ provide the best bonus  ?
```{r}
ggplot(data %>% filter(Type=="Kart"), aes(x=Speed_mean,y=Accel))+geom_point(aes(size=Weight, fill=`M-turbo`), pch=21)+ggrepel::geom_text_repel(aes(label=ID), min.segment.length = 0.1,point.padding = unit(1.2, 'lines'),box.padding = unit(0.6, 'lines'), force=2)+viridis::scale_fill_viridis()+geom_rect(aes(ymin=-Inf, ymax=0, xmin=-Inf, xmax=0), alpha=0.01, fill="red")+geom_rect(aes(ymin=0, ymax=Inf, xmin=0, xmax=Inf), alpha=0.01, fill="green")
```
```{r}
ggplot(data %>% filter(Type=="Tire"), aes(x=Speed_mean,y=Accel))+geom_point(aes(size=Weight, fill=`M-turbo`), pch=21)+ggrepel::geom_text_repel(aes(label=ID), min.segment.length = 0.1,point.padding = unit(1.2, 'lines'),box.padding = unit(0.6, 'lines'), force=2)+viridis::scale_fill_viridis()+geom_rect(aes(ymin=-Inf, ymax=0, xmin=-Inf, xmax=0), alpha=0.01, fill="red")+geom_rect(aes(ymin=0, ymax=Inf, xmin=0, xmax=Inf), alpha=0.01, fill="green")
```

```{r}
ggplot(data %>% filter(Type=="Glide"), aes(x=Speed_mean,y=Accel))+geom_point(aes(size=Weight, fill=`M-turbo`), pch=21)+ggrepel::geom_text_repel(aes(label=ID), min.segment.length = 0.1,point.padding = unit(1.2, 'lines'),box.padding = unit(0.6, 'lines'), force=2)+viridis::scale_fill_viridis()+geom_rect(aes(ymin=-Inf, ymax=0, xmin=-Inf, xmax=0), alpha=0.01, fill="red")+geom_rect(aes(ymin=0, ymax=Inf, xmin=0, xmax=Inf), alpha=0.01, fill="green")
```


#Which Item adds more Bonus than Malus ?
```{r}
data <- data %>% mutate("Bonus_Rate"=ifelse(Speed_mean > Accel, abs(Speed_mean/Accel),abs(Accel/Speed_mean)))

ggplot(data %>% filter(Type=="Kart"), aes(Bonus_Rate, ID))+geom_point()+ggrepel::geom_text_repel(aes(label=paste(Speed_mean,"/",Accel)), min.segment.length = 0.1,point.padding = unit(1.2, 'lines'),box.padding = unit(0.6, 'lines'), force=2)

```
W 25 Silver Arrow and Cat Cruiser provides the most bonus regarding to malus (4 times more bonus than malus)



#Which Char-Kart-Tire-Glide is the best combination to maximize performance ?
The parameters that need to be optimized are :

-Speed
-Acceleration
-Handling
-Turbo

Weight is mostly players preference depending on the kind of gameplay, as seen before :
-High wheight have best speed. Fits players that can dodge most enemy items, don't want to be pushed and are sure to stay on the tracks.
-Low Wheight have best acceleration. Fits players that want return to max speed faster after getting ruined by a blue shell and are able to dodge the big ones.

Note that lighter characters have Higher Handling (better turns) and better Turbo (takes less time to trigger and last longer). This is why I prefer Medium-Light characters: even if Turbo are not super-fast, I can trigger turbo more often and commit few errors (*who doesn't ?*) without being severly punished.


## Generation of all combinations
```{r}
#method1
library(gtools)

comb <- as_data_frame(permutations(n=length(data$ID),r=4,v=data$ID, repeats.allowed = F)) %>% filter(V1 %in% Char$ID & V2 %in% Kart$ID & V3 %in% Tire$ID & V4 %in% Glide$ID)

names(comb)[1] <- "ID"
comb1 <- inner_join(comb, data, by="ID")

names(comb)[1] <- "V1"
names(comb)[2] <- "ID"
comb2 <- inner_join(comb, data, by="ID")

names(comb)[2] <- "V2"
names(comb)[3] <- "ID"
comb3 <- inner_join(comb, data, by="ID")

names(comb)[3] <- "V3"
names(comb)[4] <- "ID"
comb4 <- inner_join(comb, data, by="ID")

data_combo <- comb1[,6:20]+comb2[,6:20]+comb3[,6:20]+comb4[,6:20]

data_combo <- cbind(comb[,1:4], data_combo)

names(data_combo)[1]<-"Char"
names(data_combo)[2]<-"Kart"
names(data_combo)[3]<-"Tire"
names(data_combo)[4]<-"Glidder"

data_combo$ID <- seq_len(nrow(data_combo))
```

```{r eval=FALSE}
#method 2 (not working)
data_combo <- as.data.frame((data %>% group_by(Type) %>% sample_n(1) %>% ungroup() %>% mutate_if(is.numeric,sum) %>% ungroup() %>% mutate(ID=paste(ID, collapse=" + ")) %>% select(-Type)%>%unique()))

test <- replicate(5, { rbind(data_combo, (data %>% group_by(Type) %>% sample_n(1) %>% ungroup() %>% mutate_if(is.numeric,sum) %>% ungroup() %>% mutate(ID=paste(ID, collapse=" + ")) %>% select(-Type)%>%unique()))} )
```

##Additional stats
```{r}
#Land Speed and Handling are weighted (twice more important) for mean calculation since most part of the races happens on regular soil.

data_combo  <- data_combo %>% rowwise() %>% mutate(Speed_mean=weighted.mean(x=c(Speed_Land,`Speed_Anti-G`, Speed_Water, Speed_Gliding), w=c(2,2,1,1))) %>% rowwise() %>%mutate(Handling_mean=weighted.mean(x=c(Handling_Land,`Handling_Anti-G`, Handling_Water, Handling_Gliding), w=c(2,2,1,1)))

data_combo <- data_combo %>% mutate(w_cat = cut(Weight,breaks = c(0,2,3,4,5,6),labels = c("Super Light","Light","Medium","Heavy", "Super Heavy")))#Create Weigh categories

data_combo <- data_combo %>% mutate(total_perf=as.numeric(Accel+Speed_mean+Handling_mean+Traction+`M-turbo`)) #Weigh is not included in the total_perf computing.

data_combo <- data_combo %>% select(ID, Char:Glidder, total_perf, Speed_mean, Speed_Land:Weight,w_cat, Handling_mean,Handling_Land:Bonus_Rate) %>% ungroup()


```


##Summary of data
```{r}
library(skimr)
library(ggridges)
skim(data_combo)

ggplot(data_combo, aes(total_perf, w_cat))+geom_density_ridges(aes(fill=w_cat),panel_scaling = F, alpha=0.8,rel_min_height = 0.000001)+scale_fill_brewer()

ggplot(data_combo %>% gather(key=stat, value=stat_v, c(Accel, Speed_mean, `M-turbo`,Traction, Handling_mean))) + geom_density_ridges2(aes(stat_v, w_cat, fill=w_cat), alpha=0.85)+facet_grid(stat~., switch = "y")+scale_fill_brewer()+theme(axis.ticks.y = element_blank(), axis.text.y = element_blank())

data_combo %>% group_by(w_cat) %>% select(-Char,-Glidder, -Kart, -Tire) %>% select(Accel, Speed_mean, Handling_mean, `M-turbo`,Traction)%>% skim_to_wide() %>% arrange(variable)
```
Lighest combo have higher totals once weight is put out of the balance. 


#Wich is the Most balanced Combo ?

Is there any combination that results with all stats being above or equal to 3.5 ?
```{r}
data_combo %>%filter(Speed_Land>=3.5 & Accel >= 3.5 & Handling_Land >=3.5 & `M-turbo` >=3.5 & Traction >=3.5) %>% select(Char, Kart, Tire, Glidder,total_perf,Weight, Accel, Speed_mean,Speed_Land, Handling_mean, `M-turbo`,Traction, Handling_Land)
```

I want a Weight less than 3.5 and the best Accel I can get in this list.

```{r}
data_combo %>%filter(Speed_Land>=3.5 & Accel >= 3.5 & Handling_Land >=3.5 & `M-turbo` >=3.5 & Traction >=3.5 & Weight <3.5)%>% top_n(n=5, wt=Accel) %>% select(Char, Kart, Tire, Glidder,total_perf,Weight, Accel, Speed_mean,Speed_Land, Handling_mean, `M-turbo`,Traction, Handling_Land) %>% arrange(desc(total_perf))
```


##Best overall combination ?
```{r}
ggplot(data_combo, aes(Speed_mean, Accel))+
  geom_point(pch=21, alpha=0.95, aes(fill=`M-turbo`, size=Handling_mean))+
  viridis::scale_fill_viridis(direction=1)+
  geom_abline(intercept=0, slope=1,size=1.5)+
  geom_vline(xintercept=4)+
  geom_hline(yintercept=4)+
  ggrepel::geom_label_repel(data=(data_combo %>% filter(Speed_mean >= 4 & Accel >= 4)%>% top_n(3,total_perf)), aes(x=Speed_mean, y=Accel,label=paste(round(total_perf,2),round(Speed_mean,2), round(Accel,2),"\n",Char,"+",Kart,"+", Tire,"+", Glidder)), size=2.6, segment.colour = "black",force=9,point.padding = unit(0.5, "lines"), box.padding = 0, color="black", fill="white", alpha=0.85, segment.size = 1, nudge_y = 0.5)

```

#Comparative Chart of top_n
```{r fig.height=7, fig.asp=0.68}
Best_Over_Combo <-  data_combo %>% filter(Speed_mean >= 4 & Accel >= 4)%>% top_n(5,total_perf) %>% select(ID, Char, Kart, Tire, Glidder)

ggplot(gather((data_combo %>% filter(ID %in% Best_Over_Combo$ID)),key = Stat, value=Stat_v, c(Speed_mean,Speed_Land:Speed_Gliding)),aes(paste(Char, Kart,Tire,Glidder), Stat_v))+geom_col(aes(fill=paste(Char, Kart,Tire,Glidder)))+coord_flip()+facet_grid(Stat~., scales = "free")+theme(axis.text.y = element_blank(), legend.position = "bottom", legend.text = element_text(size=7), axis.ticks.y = element_blank(), legend.direction = "vertical", legend.title.align = 0.5)+guides(fill=guide_legend(ncol=3))+labs(fill="Combo", x="", y="Scores")+scale_fill_brewer(type = "qual")
```


 problem here is that Speed_Land is low. Speen_mean was compensated by the High Speed_Water

```{r}
ggplot(data_combo, aes(Speed_mean, Accel))+geom_point(pch=21, alpha=0.95, aes(fill=`M-turbo`, size=Handling_mean))+ggrepel::geom_label_repel(data=(data_combo %>% filter(Accel>=4 & Speed_mean>5& Handling_mean>4) %>% top_n(2, total_perf)), aes(x=Speed_mean, y=Accel,label=paste(total_perf,"\n",Char,"+",Kart,"+", Tire,"+", Glidder)), size=2.6, segment.colour = "black",force=3,point.padding = unit(0.5, "lines"), box.padding = 0, color="black", fill="white", alpha=0.85,direction = "y", segment.size = 1, nudge_y = 0.5)+viridis::scale_fill_viridis(direction=1)+geom_abline(intercept=0, slope=1)



```

```{r}
ggplot(gather(data_combo %>% filter(Accel>=4 & Speed_mean>5& Handling_mean>4) %>% top_n(1, total_perf),key = Stat, value=Stat_v, c(Speed_Land:Speed_Gliding,Accel, Weight, Handling_Land:Handling_Gliding, Traction, `M-turbo`)),aes(Stat, Stat_v))+geom_col()+coord_flip()

```


#Best combinations for Yoshi
```{r}
data_combo %>%filter(Char=="Peach", Speed_Land >3) %>% select(Char, Kart, Tire, Glidder,total_perf,Weight, Accel, Speed_mean,Speed_Land, Handling_mean, `M-turbo`,Traction, Handling_Land) %>% arrange(desc(total_perf)) %>% top_n(10, Accel)

ggplot(data_combo %>%filter(Char=="Peach"), aes(Speed_mean, Accel))+
  geom_point(pch=21, alpha=0.85, aes(fill=`M-turbo`, size=Handling_mean))+
  ggrepel::geom_label_repel(data=(data_combo %>%filter(Char=="Peach", Speed_mean >= 3 & Accel >= 3) %>% top_n(2, total_perf)), aes(x=Speed_mean, y=Accel,label=paste(total_perf,"\n",Kart,"+", Tire,"+", Glidder,"\n", w_cat)), size=2.6, segment.colour = "black",force=5,point.padding = unit(0.5, "lines"), box.padding = 1.5, color="black", fill="white", alpha=0.87, direction = "y")+
  scale_fill_distiller(direction=1, palette="Greens")
```
